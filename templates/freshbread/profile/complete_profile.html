{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Complete Profile - Kingfood</title>
<link rel="icon" type="image/png" href="{% static 'images/favicon.ico' %}" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
    * { box-sizing: border-box; font-family: "Roboto", sans-serif; }

    body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: radial-gradient(
                circle at top left,
                rgba(255, 96, 219, 0.40),
                transparent 45%
            ),
            radial-gradient(
                circle at bottom right,
                rgba(86, 191, 255, 0.40),
                transparent 45%
            ),
            linear-gradient(
                135deg,
                #142050,
                #1a2b63,
                #1f3a7a
            );
        background-size: cover;
        background-attachment: fixed;
        overflow: hidden;
        padding-top: 40px; /* ⁄©ŸÖ€å ŸÅÿßÿµŸÑŸá ÿßÿ≤ ÿ®ÿßŸÑÿß ÿ®ÿ±ÿß€å ŸÖŸàÿ®ÿß€åŸÑ */
    }

    /* Glassmorphism card */
    .profile-card {
        position: relative;
        width: 440px;
        max-width: 92%;
        padding: 45px 35px;
        border-radius: 22px;
        background: rgba(39, 44, 85, 0.5);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 0 30px rgba(0,0,0,0.4), inset 0 0 20px rgba(255,255,255,0.05);
        animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    h2 {
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 30px;
        letter-spacing: 1px;
        background: linear-gradient(90deg, #ff43c1, #7acbff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .form-group {
        position: relative;
        margin-bottom: 22px;
    }

    .form-group i {
        position: absolute;
        top: 50%;
        left: 16px;
        transform: translateY(-50%);
        color: #c8d2e0;
        font-size: 17px;
        z-index: 1;
    }

    .form-group input,
    .form-group input[type="number"] {
        width: 100%;
        padding: 15px 16px 15px 48px;
        background: rgba(255,255,255,0.08);
        border: none;
        border-radius: 12px;
        font-size: 15px;
        color: #fff;
        outline: none;
        transition: 0.25s;
        backdrop-filter: blur(6px);
    }

    .form-group input::placeholder {
        color: #a9b3c6;
    }

    .form-group input:focus {
        background: rgba(255,255,255,0.18);
        box-shadow: 0 0 12px rgba(110,180,255,0.45);
    }

    /* Map container */
    .map-wrapper {
        margin: 10px 0 20px;
    }

    .map-wrapper label {
        display: block;
        color: #d5d8e1;
        font-weight: 500;
        margin-bottom: 10px;
        font-size: 15px;
    }

    #map {
        height: 260px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.12);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        background: rgba(0,0,0,0.2);
    }

    #location-status, #live-address {
        margin-top: 10px;
        font-size: 14px;
        color: #c8d2e0;
        line-height: 1.5;
    }

    .location-btn {
        margin: 12px 0 18px;
        width: 100%;
        padding: 13px;
        border-radius: 12px;
        border: none;
        background: rgba(255,255,255,0.1);
        color: white;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        backdrop-filter: blur(6px);
        transition: 0.3s;
        border: 1px solid rgba(255,255,255,0.15);
    }

    .location-btn:hover {
        background: rgba(255,255,255,0.18);
        box-shadow: 0 0 15px rgba(110,180,255,0.4);
    }

    .btn-submit {
        width: 100%;
        padding: 15px;
        margin-top: 10px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(90deg, #ff45c4, #6bc7ff);
        color: #fff;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        letter-spacing: 1px;
        box-shadow: 0 0 15px rgba(255,255,255,0.25);
        transition: 0.3s;
    }

    .btn-submit:hover {
        filter: brightness(1.15);
        transform: scale(1.02);
    }

    /* Floating decor dots */
    .dot {
        position: absolute;
        border-radius: 50%;
        background: rgba(255,255,255,0.08);
        filter: blur(4px);
        animation: float 7s ease-in-out infinite;
    }

    @keyframes float {
        0%,100% { transform: translateY(0); }
        50%     { transform: translateY(-14px); }
    }

    .d1 { width: 90px;  height: 90px;  top: -45px; left: -40px; animation-delay: 0s; }
    .d2 { width: 60px;  height: 60px;  bottom: -35px; right: -30px; animation-delay: 2s; }
    .d3 { width: 45px;  height: 45px;  top: 40%; right: -25px; animation-delay: 4s; }

    /* Error / status */
    #error-banner, .top-error-banner {
        background: rgba(220,38,38,0.85);
        backdrop-filter: blur(8px);
        color: white;
        padding: 14px 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 15px;
        border: 1px solid rgba(255,255,255,0.1);
    }
</style>

</head>
<body>

{% if messages %}
<div id="topErrorBanner" class="top-error-banner" role="alert">
    <i class="fa fa-exclamation-circle"></i>
    {% for message in messages %}
        <span>{{ message }}</span>
    {% endfor %}
</div>
{% endif %}

<div class="profile-card">

    <div class="dot d1"></div>
    <div class="dot d2"></div>
    <div class="dot d3"></div>

    <h2>COMPLETE PROFILE</h2>

    <form method="POST">
        {% csrf_token %}

        <div class="form-group">
            <i class="fa fa-user"></i>
            <input type="text" name="first_name" placeholder="First Name" required>
        </div>

        <div class="form-group">
            <i class="fa fa-user"></i>
            <input type="text" name="last_name" placeholder="Last Name" required>
        </div>

        <div class="form-group">
            <i class="fa fa-phone"></i>
            <input type="number" name="phone" placeholder="Phone number" required>
        </div>

        <div class="form-group">
            <i class="fa fa-map-marker-alt"></i>
            <input type="text" name="postalcode" placeholder="Postal code" required>
        </div>

        <div class="form-group">
            <i class="fa fa-gift"></i>
            <input type="text" name="referral_code" placeholder="Referral code (optional)">
        </div>

        <!-- Map Section -->
        <div class="map-wrapper">
            <label>Select Location (Ottawa Area Only)</label>
            <button type="button" id="locateMe" class="location-btn">üìç Use My Location</button>
            <div id="map"></div>
            <p id="location-status">Move the map or use GPS to select your location...</p>
            <p id="live-address"></p>

            <!-- Hidden fields -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">
            <input type="hidden" name="complete_address" id="complete_address">
        </div>

        <button type="submit" class="btn-submit">Continue</button>
    </form>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ŸáŸÖÿßŸÜ ⁄©ÿØ ÿ¨ÿßŸàÿßÿßÿ≥⁄©ÿ±€åŸæÿ™ ŸÇÿ®ŸÑ€å ÿ¥ŸÖÿß ÿ®ÿØŸàŸÜ ÿ™ÿ∫€å€åÿ± (ŸÅŸÇÿ∑ ÿßÿ≥ÿ™ÿß€åŸÑ ÿπŸàÿ∂ ÿ¥ÿØŸá)
const ottawaCenter = [45.4215, -75.6993];
const bounds = L.latLngBounds([45.2, -75.95], [45.55, -75.3]);

const map = L.map('map', {
    center: ottawaCenter,
    zoom: 13,
    maxBounds: bounds,
    maxBoundsViscosity: 1.0
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

const status = document.getElementById("location-status");
const latInput = document.getElementById("latitude");
const lngInput = document.getElementById("longitude");
const addrInput = document.getElementById("complete_address");

let lastValidPos = ottawaCenter.slice();
const marker = L.marker(ottawaCenter, { draggable: true }).addTo(map);

function setStatus(text, color="#c8d2e0") {
    status.innerHTML = text;
    status.style.color = color;
}

async function validateLocation(lat, lng, showMessage=true) {
    try {
        const res = await fetch(`/api/reverse-geocode?lat=${lat}&lon=${lng}`);
        const data = await res.json();

        const addr = data.address || {};
        const displayName = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

        if ((addr.road || addr.pedestrian || addr.cycleway || addr.footway) && addr.city === "Ottawa") {
            lastValidPos = [lat, lng];
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);
            addrInput.value = displayName;
            setStatus(`üìç Selected: ${displayName}<br>Lat: ${lat.toFixed(6)} ‚Ä¢ Lng: ${lng.toFixed(6)}`, "#7acbff");
            return true;
        } else {
            if(showMessage) alert("‚ö†Ô∏è Please place the marker on a street/road in Ottawa.");
            marker.setLatLng(lastValidPos);
            map.panTo(lastValidPos);
            setStatus("Place marker on a valid Ottawa street.", "#ff6b6b");
            return false;
        }
    } catch(e) {
        if(showMessage) alert("‚ö†Ô∏è Cannot verify location right now.");
        marker.setLatLng(lastValidPos);
        map.panTo(lastValidPos);
        setStatus("Location verification failed.", "#ff6b6b");
        return false;
    }
}

marker.on('dragend', async e => {
    const { lat, lng } = e.target.getLatLng();
    await validateLocation(lat, lng);
});

map.on('click', async e => {
    const { lat, lng } = e.latlng;
    marker.setLatLng([lat, lng]);
    map.panTo([lat, lng]);
    await validateLocation(lat, lng);
});

document.getElementById("locateMe").addEventListener("click", () => {
    if(!navigator.geolocation) return alert("Geolocation not supported.");
    setStatus("Fetching your location...", "#facc15");
    navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        const current = L.latLng(latitude, longitude);
        if(bounds.contains(current)) {
            marker.setLatLng(current);
            map.setView(current, 15);
            await validateLocation(latitude, longitude);
        } else {
            alert("Your location is outside Ottawa area.");
            marker.setLatLng(ottawaCenter);
            map.setView(ottawaCenter, 12);
            await validateLocation(ottawaCenter[0], ottawaCenter[1], false);
        }
    }, () => {
        alert("Cannot access location. Please allow GPS.");
        setStatus("Location access denied.", "#ff6b6b");
    });
});

// ÿ¥ÿ±Ÿàÿπ ÿßŸàŸÑ€åŸá
validateLocation(ottawaCenter[0], ottawaCenter[1], false);
</script>

</body>
</html>