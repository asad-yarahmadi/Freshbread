{% load static %}

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">    
	<!-- Site CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">    
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4/animate.min.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% if messages %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const messages = [
        {% for message in messages %}
        { text: "{{ message|escapejs }}", tag: "{{ message.tags }}" },
        {% endfor %}
    ];
    function getAlertColors(tag) {
        switch (tag) {
            case 'success': return { bg: '#22c55e', text: '#fff', icon: 'success' };
            case 'error': return { bg: '#dc2626', text: '#fff', icon: 'error' };
            case 'warning': return { bg: '#facc15', text: '#000', icon: 'warning' };
            default: return { bg: '#facc15', text: '#000', icon: 'warning' };
        }
    }
    function isMobile() { return window.innerWidth < 768; }
    function showNextMessage(index = 0) {
        if (index >= messages.length) return;
        const colors = getAlertColors(messages[index].tag);
        const mobile = isMobile();
        Swal.fire({
            title: messages[index].text,
            icon: colors.icon,
            background: colors.bg,
            color: colors.text,
            timer: 7000,
            timerProgressBar: true,
            showConfirmButton: false,
            toast: !mobile,
            position: mobile ? 'center' : 'top-end',
            customClass: { popup: mobile ? 'swal-wide' : '' },
            showClass: { popup: 'animate__animated animate__fadeInDown' },
            hideClass: { popup: 'animate__animated animate__fadeOutUp' },
            didOpen: (popup) => {
                popup.addEventListener('mouseenter', Swal.stopTimer);
                popup.addEventListener('mouseleave', Swal.resumeTimer);
            }
        }).then(() => { showNextMessage(index + 1); });
    }
    showNextMessage();
});
</script>
<style>
.swal-wide { width: 90% !important; font-size: 1.1rem !important; }
</style>
{% endif %}
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">   
   
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

 
     <!-- Site Metas -->
    <title>Fresh Bread - Exprince more Tastes!</title>  
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Site Icons -->
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{% static 'images/apple-touch-icon.png' %}">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<header class="top-navbar">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="{% url 'index' %}">
        <img src="{% static 'images/logo.png' %}" alt="Logo" />
      </a>

      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbars-rs-food"
        aria-controls="navbars-rs-food"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbars-rs-food">
        <ul class="navbar-nav ml-auto align-items-center">
          <li class="nav-item {% if request.resolver_match.url_name == 'index' %}active{% endif %}"><a class="nav-link" href="{% url 'index' %}">Home</a></li>
          <li class="nav-item {% if request.resolver_match.url_name == 'menu' %}active{% endif %}"><a class="nav-link" href="{% url 'menu' %}">Menu</a></li>
          
          <li class="nav-item dropdown {% if request.resolver_match.url_name == 'stuff' or request.resolver_match.url_name == 'gallery' or request.resolver_match.url_name == 'about' or request.resolver_match.url_name == 'coming_soon' %}active{% endif %}">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown-pages" data-toggle="dropdown">Pages</a>
            <div class="dropdown-menu" aria-labelledby="dropdown-pages">
              <a class="dropdown-item" href="{% url 'stuff' %}">Stuff</a>
              <a class="dropdown-item" href="{% url 'gallery' %}">Gallery</a>
              <a class="dropdown-item" href="{% url 'about' %}">About</a>
              <a class="dropdown-item" href="{% url 'coming_soon' %}">Coming soon</a>

            </div>
          </li>

          <li class="nav-item dropdown {% if request.resolver_match.url_name == 'blog' or request.resolver_match.url_name == 'blog_manage' %}active{% endif %}">
            <a class="nav-link dropdown-toggle" href="#" id="dropdown-blog" data-toggle="dropdown">Blog</a>
            <div class="dropdown-menu" aria-labelledby="dropdown-blog">
              <a class="dropdown-item" href="{% url 'blog' %}">Blog</a>
              <a class="dropdown-item" href="{% url 'blog_manage' %}">Manage blogs</a>
            </div>
          </li>

          <li class="nav-item {% if request.resolver_match.url_name == 'contact' %}active{% endif %}"><a class="nav-link" href="{% url 'contact' %}">Contact</a></li>

          {% if user.is_authenticated and user.is_staff %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-danger font-weight-bold" href="#" id="dropdown-admin" data-toggle="dropdown">
              Admin CP
            </a>
            <div class="dropdown-menu" aria-labelledby="dropdown-admin">
              <a class="dropdown-item" href="{% url 'manage' %}">Manage Foods</a>
              <a class="dropdown-item" href="{% url 'review_check' %}">Review Check</a>
              <a class="dropdown-item" href="{% url 'admin_email' %}">Email Sender</a>
              <a class="dropdown-item" href="{% url 'admin_order_reviews' %}">Order check</a>
              <a class="dropdown-item" href="{% url 'manage_orders' %}">Orders manage</a>
              <a class="dropdown-item" href="/admin_adminali_admin/infrastructure/galleryimage/">Manage Gallery</a>
              <a class="dropdown-item" href="{% url 'admin_users' %}">Users manage</a>
              <a class="dropdown-item" href="{% url 'admin_tickets' %}">Tickets manage</a>
              
            </div>
          </li>
          {% endif %}

          <li class="nav-item dropdown position-relative" id="cart-menu">
  <a class="nav-link d-flex align-items-center cart-link" href="{% url 'reservation' %}">
    <i class="fa fa-shopping-cart fa-lg cart-icon"></i>
    <span class="cart-text">Cart</span>



    {% if cart_items|length > 0 %}
      <span id="cart-count" class="cart-count">{{ cart_items|length }}</span>
    {% endif %}
  </a>


  <!-- popup -->
  <div id="cart-popup" class="cart-popup shadow-lg" role="menu" aria-label="Cart popup">
    <span class="cart-text">Cart</span>


    <div class="cart-items">
      {% if cart_items %}
        {% for item in cart_items %}
        <div class="cart-item"
             data-slug="{{ item.product.slug }}"
             data-price="{{ item.product.price|floatformat:2 }}"
             data-original="{{ item.product.original_price|default:item.product.price|floatformat:2 }}">

  
  <!-- ØªØµÙˆÛŒØ± Ù…Ø­ØµÙˆÙ„ -->
  <img src="{{ item.product.menu_image.url }}" alt="{{ item.product.name }}" class="cart-img">

  <div class="item-info">
    <!-- Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ -->
    <p class="name">{{ item.product.name }}</p>

    <!-- Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ -->
    <p class="price-final">
      $<span class="price-value">{{ item.product.price|floatformat:2 }}</span>
    </p>

    <!-- Ø§Ú¯Ø± ØªØ®ÙÛŒÙ Ø¯Ø§Ø´Øª -->
    {% if item.discount_amount > 0 %}
      <p class="discount-label text-danger">
        - $<span class="discount-value">{{ item.discount_amount|floatformat:2 }}</span> Off
      </p>
    {% endif %}

    <!-- Ú©Ù†ØªØ±Ù„ ØªØ¹Ø¯Ø§Ø¯ -->
    <div class="quantity-control">
      <button class="decrease" type="button" aria-label="Decrease">âˆ’</button>
      <span class="quantity">{{ item.quantity }}</span>
      <button class="increase" type="button" aria-label="Increase">+</button>
    </div>

    <!-- Ø¬Ù…Ø¹ Ù‡Ø± Ø¢ÛŒØªÙ… -->
    <p class="item-total">
      Item Total: $<span class="item-total-value">{{ item.item_total|floatformat:2 }}</span>
    </p>
  </div>
</div>

        {% endfor %}
      {% else %}
        <p class="empty-cart">ðŸ›’ Your cart is empty.</p>
      {% endif %}
    </div>

    <div class="cart-popup-footer">
      <div class="cart-total-row">
        <span>Total:</span>
        <span id="cart-total">$0.00</span>
      </div>
      <div class="cart-buttons">
        <button id="continue-shopping" class="btn-continue" type="button">Continue Shopping</button>
      </div>
    </div>
  </div>
</li>
          <!-- Profile -->
          <li class="nav-item ml-2">
            {% if user.is_authenticated %}
              <a class="nav-link" href="{% url 'profile' %}">
                <i class="fas fa-user-circle"></i>
              </a>
            {% else %}
              <a class="nav-link font-weight-bold" href="{% url 'ru' %}">
                Login
              </a>
            {% endif %}
          </li>

        </ul>
      </div>
    </div>
  </nav>
</header>
<!-- scripts are loaded in footer.html to avoid duplication -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const popup = document.getElementById("cart-popup");
  const cartCountElem = document.getElementById("cart-count");
  const cartTotalElem = document.getElementById("cart-total");
  const continueBtn = document.getElementById("continue-shopping");
  if (!popup) return;
  function calcItemTotals(item) {
    const price = parseFloat(item.dataset.price);
    const qty = parseInt(item.querySelector(".quantity").textContent);
    const itemTotal = price * qty;
    item.querySelector(".price-value").textContent = price.toFixed(2);
    item.querySelector(".item-total-value").textContent = itemTotal.toFixed(2);
    return itemTotal;
  }
  function updateCartTotal() {
    let total = 0;
    popup.querySelectorAll(".cart-item").forEach(item => total += calcItemTotals(item));
    if (cartTotalElem) cartTotalElem.textContent = "$" + total.toFixed(2);
  }
  function updateCartCount() {
    if (!cartCountElem) return;
    let count = 0;
    popup.querySelectorAll(".cart-item .quantity").forEach(q => count += parseInt(q.textContent));
    if (count > 0) {
      cartCountElem.style.display = "inline-block";
      cartCountElem.textContent = count;
    } else {
      cartCountElem.style.display = "none";
    }
  }
  updateCartTotal();
  updateCartCount();
  popup.addEventListener("click", function (e) {
    const incBtn = e.target.closest(".increase");
    const decBtn = e.target.closest(".decrease");
    if (incBtn || decBtn) {
      e.stopPropagation();
      const item = e.target.closest(".cart-item");
      const slug = item.dataset.slug;
      const quantityElem = item.querySelector(".quantity");
      let qty = parseInt(quantityElem.textContent);
      if (incBtn) qty++;
      if (decBtn) qty--;
      qty = Math.max(0, Math.min(qty, 5));
      fetch(`/cart/set_cart_quantity/${slug}/${qty}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}", "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (qty === 0) { item.remove(); } else { quantityElem.textContent = qty; }
          updateCartTotal();
          updateCartCount();
        }
      })
      .catch(err => console.error("Error:", err));
      return;
    }
    if (e.target.closest("#continue-shopping")) {
      e.stopPropagation();
      window.location.href = "{% url 'menu' %}";
      return;
    }
  });
  const headerCartIcon = document.querySelector(".fa-shopping-cart");
  if (headerCartIcon) {
    headerCartIcon.addEventListener("click", function (e) {
      e.preventDefault();
      window.location.href = "{% url 'reservation' %}";
    });
  }
});
</script>