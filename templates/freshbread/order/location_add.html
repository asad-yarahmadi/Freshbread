{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% if edit %}Edit Location{% else %}Add Location{% endif %} - Fresh Bread</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">

  <!-- Bootstrap Icons برای آیکون دکمه (اختیاری - اگر نمی‌خوای حذفش کن) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
{% include 'freshbread/header.html' %}

<h2></h2><br>
<h2></h2><br> 

<div class="container mt-4">
    <h2>{% if edit %}Edit Location{% else %}Add Location{% endif %}</h2>
    <form method="post" action="">
      {% csrf_token %}
      <h2></h2><br>

      <div class="form-group">
        <label>Select Location (Ottawa)</label>
        <div id="map" style="height:300px;border-radius:12px;"></div>
        <small class="form-text text-muted">
          Pick a location first to unlock fields. (Please wait until your address appears in the address box. It may take a few seconds)
        </small>

        <!-- دکمه جدید: Find My Location -->
        <button type="button" id="btnFindLocation" class="btn btn-primary mt-3">
          <i class="bi bi-geo-alt-fill me-1"></i> Find My Location
        </button>

        <input type="hidden" name="latitude" id="latitude" value="{% if location %}{{ location.latitude }}{% endif %}">
        <input type="hidden" name="longitude" id="longitude" value="{% if location %}{{ location.longitude }}{% endif %}">
      </div>

      <div class="form-group">
        <label>Address</label>
        <input type="text" name="address_line" id="address_line" class="form-control" value="{% if location %}{{ location.address_line }}{% endif %}" {% if not edit %}disabled{% endif %}>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label>Postal Code</label>
          <input type="text" name="postal_code" id="postal_code" class="form-control" value="{% if location %}{{ location.postal_code }}{% endif %}" {% if not edit %}disabled{% endif %}>
        </div>
        <div class="form-group col-md-6">
          <label>House Number</label>
          <input type="text" name="house_number" id="house_number" class="form-control" value="{% if location %}{{ location.house_number }}{% endif %}" {% if not edit %}disabled{% endif %}>
        </div>
      </div>

      <div class="form-group">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="receiver_is_user" name="receiver_is_user" {% if location and location.receiver_is_user %}checked{% endif %}>
          <label class="form-check-label" for="receiver_is_user">I'm the receiver</label>
        </div>
      </div>

      <div id="receiverFields" style="display:{% if edit %}{% if location and not location.receiver_is_user %}block{% else %}none{% endif %}{% else %}block{% endif %};">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Receiver Name</label>
            <input type="text" name="receiver_name" id="receiver_name" class="form-control" value="{% if location %}{{ location.receiver_name }}{% endif %}">
          </div>
          <div class="form-group col-md-6">
            <label>Receiver Phone</label>
            <input type="text" name="receiver_phone" id="receiver_phone" class="form-control" value="{% if location %}{{ location.receiver_phone }}{% endif %}">
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-success">{% if edit %}Save{% else %}Add Location{% endif %}</button>
    </form>
</div>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
<script src="{% static 'js/popper.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<!-- ALL PLUGINS -->
<script src="{% static 'js/jquery.superslides.min.js' %}"></script>
<script src="{% static 'js/images-loded.min.js' %}"></script>
<script src="{% static 'js/isotope.min.js' %}"></script>
<script src="{% static 'js/baguetteBox.min.js' %}"></script>
<script src="{% static 'js/form-validator.min.js' %}"></script>
<script src="{% static 'js/contact-form-script.js' %}"></script>
<script src="{% static 'js/custom.js' %}"></script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const defaultCenter = [45.3290, -75.9040];  // Kanata center (پیش‌فرض)

  // Bounding box بزرگ‌تر برای پوشش کل Ottawa (تقریبی بر اساس داده‌های جغرافیایی)
  // جنوب: ~45.15, شمال: ~45.55, غرب: ~-76.2, شرق: ~-75.3
  const ottawaBounds = L.latLngBounds(
    [45.15, -76.20],   // جنوب غربی
    [45.55, -75.30]    // شمال شرقی
  );

  const map = L.map('map', { 
    center: defaultCenter, 
    zoom: 13,
    maxBounds: ottawaBounds,
    maxBoundsViscosity: 0.8  // کمی شل‌تر تا کاربر راحت‌تر حرکت کنه
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution: '&copy; OpenStreetMap contributors' 
  }).addTo(map);

  const latInput = document.getElementById('latitude');
  const lngInput = document.getElementById('longitude');
  const addrInput = document.getElementById('address_line');
  const postalInput = document.getElementById('postal_code');
  const houseInput = document.getElementById('house_number');

  let start = defaultCenter.slice();
  if(latInput.value && lngInput.value){ 
    start = [parseFloat(latInput.value), parseFloat(lngInput.value)]; 
    map.setView(start, 15); 
  }

  const marker = L.marker(start, {draggable:true}).addTo(map);

  function unlock(){
    addrInput.disabled = false; 
    postalInput.disabled = false; 
    houseInput.disabled = false; 
  }

  function lock(){
    addrInput.disabled = true; 
    postalInput.disabled = true; 
    houseInput.disabled = true; 
  }

  function resetToDefault() {
    marker.setLatLng(defaultCenter);
    map.setView(defaultCenter, 13);
    latInput.value = '';
    lngInput.value = '';
    addrInput.value = '';
    lock();
  }

  async function validateLocation(lat, lng){
    const point = L.latLng(lat, lng);

    // چک کردن محدوده مجاز (Ottawa کلی)
    if (!ottawaBounds.contains(point)) {
      alert('The selected location is outside Ottawa. Please choose a point within the city of Ottawa.');
      resetToDefault();  // برگشت به Kanata center
      return;
    }

    // اگر داخل Ottawa بود → چک reverse geocode برای آدرس معتبر
    try {
      const res = await fetch(`/api/reverse-geocode?lat=${lat}&lon=${lng}`);
      const data = await res.json();
      const a = data.address || {};
      const displayName = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

      // چک اضافی: حداقل یک road یا مشابه داشته باشه (خیابان معتبر)
      if (a.road || a.pedestrian || a.cycleway || a.footway) {
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
        addrInput.value = displayName;
        unlock();
      } else {
        alert('This point does not appear to be a valid street address in Ottawa. Please select a location on a road or street.');
        resetToDefault();
      }
    } catch(e) {
      alert('Unable to verify the location. Please try again.');
      resetToDefault();
    }
  }

  marker.on('dragend', async e => { 
    const {lat, lng} = e.target.getLatLng(); 
    await validateLocation(lat, lng); 
  });

  map.on('click', async e => { 
    const {lat, lng} = e.latlng; 
    marker.setLatLng([lat, lng]); 
    await validateLocation(lat, lng); 
  });

  // Find My Location
  function onLocationFound(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    marker.setLatLng([lat, lng]);
    map.setView([lat, lng], 15);
    validateLocation(lat, lng);
  }

  function onLocationError(e) {
    alert(e.message || "Could not get your location. Please allow location access in your browser settings.");
  }

  document.getElementById('btnFindLocation').addEventListener('click', function() {
    map.locate({
      setView: true,
      maxZoom: 16,
      enableHighAccuracy: true
    });
  });

  map.on('locationfound', onLocationFound);
  map.on('locationerror', onLocationError);

  // Receiver checkbox
  const chk = document.getElementById('receiver_is_user');
  const rf = document.getElementById('receiverFields');
  rf.style.display = chk.checked ? 'none' : 'block';
  chk.addEventListener('change', () => { 
    rf.style.display = chk.checked ? 'none' : 'block'; 
  });

  // Fix map rendering
  setTimeout(function() {
    map.invalidateSize();
  }, 400);

</script>

{% include 'freshbread/footer.html' %}
</body>
</html>