{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout – Step 2 - Fresh Bread</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">

    <style>
        .modal-backdrop{opacity:.5}
        .big-email{font-size:28px;font-weight:800;color:#C47A3A;text-align:center}
    </style>
</head>
{% include 'freshbread/header.html' %}
<body>
<h2></h2><br>
<h2></h2><br>
  <div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card p-4">
                <h4 class="mb-3">How to use</h4>
                <ol>
                  <li>Make sure your Interac e-Transfer email matches your site account email. You can update it <a href="{% url 'edit_profile' %}">here</a>.</li>
                  <li>Send the payment to <strong>order.freshbread911@gmail.com</strong>.</li>
                  <li>After paying, note the Reference Number shown by the payment app.</li>
                  <li>Click “I've payed” to verify your payment.</li>
                </ol>
                <div class="quiet-box mb-3">Total: <strong>${{ payable }}</strong></div>
                <div class="big-email">order.freshbread911@gmail.com</div>
                <div class="mt-4 d-flex justify-content-center">
                    <button class="btn btn-success mx-2" id="paidBtn" disabled>I've payed</button>
                    <a href="{% url 'checkout_cancel' %}" class="btn btn-outline-danger mx-2" id="cancelBtn" disabled>cancel</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="noticeModal" style="display:block; background:rgba(0,0,0,.4)">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Notice</h5></div>
      <div class="modal-body">
        <p>Use Interac e-Transfer with the same email as your site account. If different, change it <a href="{% url 'edit_profile' %}">here</a>. Note the reference number after payment.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="readBtn">I read this</button>
      </div>
    </div>
  </div>
</div>

<form id="paidForm" method="post" action="{% url 'checkout_paid' %}" style="display:none">
  {% csrf_token %}
</form>
{% include 'freshbread/footer.html' %}
<script>
let skipCancel = false;
document.getElementById('readBtn').addEventListener('click', function(){
  document.getElementById('noticeModal').style.display = 'none';
  document.getElementById('paidBtn').disabled = false;
  document.getElementById('cancelBtn').disabled = false;
  document.getElementById('verifyInfoBtn').disabled = false;
});
document.getElementById('paidBtn').addEventListener('click', function(){
  try { skipCancel = true; sessionStorage.setItem('skipCancel', '1'); } catch(e) {}
  document.getElementById('paidForm').submit();
});
function cancelCheckout(){
  try{
    if (skipCancel || sessionStorage.getItem('skipCancel') === '1') return;
    navigator.sendBeacon('{% url 'checkout_cancel' %}');
  }catch(e){}
}
document.addEventListener('visibilitychange', function(){
  if (document.visibilityState === 'hidden') cancelCheckout();
});
window.addEventListener('pagehide', cancelCheckout);

// Verification details modal
var verifyModal = document.createElement('div');
verifyModal.className = 'modal';
verifyModal.id = 'verifyModal';
verifyModal.style.display = 'none';
verifyModal.innerHTML = '<div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Verification Details</h5></div><div class="modal-body"><div id="verifyContent">Loading...</div></div><div class="modal-footer"><button type="button" class="btn btn-light" id="closeVerifyModal">Close</button></div></div></div>';
document.body.appendChild(verifyModal);

document.getElementById('verifyInfoBtn').addEventListener('click', function(){
  verifyModal.style.display = 'block';
  fetch('#', { method: 'GET', credentials: 'same-origin' })
    .then(r => r.json())
    .then(d => {
      var html = '';
      if (!d.configured){
        html += '<p>Verification not configured (missing inbox password).</p>';
      } else {
        html += '<p><strong>From email:</strong> ' + (d.from_email || '-') + '</p>';
        html += '<p><strong>Matched payments:</strong> ' + d.matched_count + '</p>';
        html += '<p><strong>Total found:</strong> $' + Number(d.total_found).toFixed(2) + '</p>';
        html += '<p><strong>Total due:</strong> $' + Number(d.total_due).toFixed(2) + '</p>';
        html += '<p><strong>Status:</strong> ' + d.status + '</p>';
        if (d.status === 'low'){
          html += '<p><strong>Remaining:</strong> $' + Number(d.remaining).toFixed(2) + '</p>';
        }
        if (d.last_reference){
          html += '<p><strong>Latest Reference Number:</strong> ' + d.last_reference + '</p>';
        }
      }
      document.getElementById('verifyContent').innerHTML = html;
    })
    .catch(() => {
      document.getElementById('verifyContent').innerHTML = 'Error fetching details.';
    });
});
document.getElementById('closeVerifyModal').addEventListener('click', function(){
  verifyModal.style.display = 'none';
});
</script>
<script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
</body>
</html>