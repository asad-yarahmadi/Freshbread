{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Review Moderation - Fresh Bread</title>

    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --primary: #e67e22;
            --primary-dark: #d35400;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2d3748;
            --text-muted: #718096;
        }

        body {
            background: var(--light-bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
        }

        .admin-wrapper {
            max-width: 1180px;
            margin: 40px auto 80px;
            padding: 0 15px;
        }

        .page-heading {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2.5rem;
            text-align: center;
            position: relative;
        }

        .page-heading:after {
            content: '';
            width: 90px;
            height: 4px;
            background: var(--primary);
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text);
            margin: 3rem 0 1.6rem;
            padding-bottom: 0.7rem;
            border-bottom: 3px solid var(--primary);
            display: inline-block;
        }

        .review-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.8rem 2rem;
            margin-bottom: 1.8rem;
            box-shadow: 0 6px 22px rgba(0,0,0,0.07);
            transition: all 0.3s ease;
            border: 1px solid #edf2f7;
        }

        .review-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 38px rgba(0,0,0,0.11);
        }

        .review-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .review-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--success);
            box-shadow: 0 4px 12px rgba(40,167,69,0.2);
            margin-right: 1.3rem;
            flex-shrink: 0;
        }

        .review-user h5 {
            margin: 0 0 0.35rem;
            font-weight: 600;
            font-size: 1.15rem;
        }

        .review-user small {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .review-info {
            font-size: 0.98rem;
            color: #4a5568;
            margin: 0.7rem 0;
            line-height: 1.6;
        }

        .review-rating {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f6ad55;
            margin: 0.8rem 0 1rem;
        }

        .review-text {
            line-height: 1.75;
            color: #4a5568;
            margin-bottom: 1.4rem;
        }

        .review-thumbs {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-top: 1.3rem;
        }

        .thumb {
            width: 94px;
            height: 94px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .thumb:hover {
            transform: scale(1.07);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(230,126,34,0.25);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .review-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.9rem;
            margin-top: 1.6rem;
            padding-top: 1.3rem;
            border-top: 1px solid #edf2f7;
        }

        .btn-review-action {
            padding: 0.6rem 1.4rem;
            font-size: 0.96rem;
            border-radius: 8px;
            min-width: 118px;
        }

        .status-badge {
            padding: 0.55em 1.1em;
            border-radius: 999px;
            font-weight: 500;
            font-size: 0.92rem;
        }

        /* Modal */
        .img-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1050;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .img-modal.active {
            display: flex;
        }

        .modal-body {
            background: white;
            border-radius: 16px;
            max-width: 720px;
            width: 94%;
            padding: 2rem;
            position: relative;
            box-shadow: 0 25px 60px rgba(0,0,0,0.45);
        }

        .modal-close-btn {
            position: absolute;
            top: 18px;
            right: 22px;
            font-size: 2.4rem;
            color: #4a5568;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: var(--danger);
        }

        .modal-main-img {
            max-width: 100%;
            max-height: 540px;
            border-radius: 12px;
            margin-bottom: 1.4rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        }

        .empty-state {
            background: white;
            border-radius: 16px;
            padding: 5rem 2rem;
            text-align: center;
            box-shadow: 0 6px 22px rgba(0,0,0,0.06);
            color: var(--text-muted);
        }

        @media (max-width: 992px) {
            .review-header { flex-direction: column; align-items: flex-start; }
            .review-avatar { margin-right: 0; margin-bottom: 1.2rem; }
        }
    </style>
</head>
<body>

{% include 'freshbread/header.html' %}

<div class="admin-wrapper">

    <h1 class="page-heading">Review Moderation Dashboard</h1>

    <!-- ── Product Reviews ── -->
    <h4 class="section-title">Product Reviews</h4>

    {% if reviews %}
        {% for review in reviews %}
        <div class="review-card">
            <div class="review-header">
                <img class="review-avatar"
                     src="{% if review.user.profile.avatar %}{{ review.user.profile.avatar.url }}{% else %}{% static 'images/profile-7.jpg' %}{% endif %}"
                     alt="{{ review.first_name }} {{ review.last_name }}"
                     onerror="this.src='{% static 'images/profile-7.jpg' %}'">
                <div class="review-user">
                    <h5>{{ review.first_name }} {{ review.last_name }}</h5>
                    <small>{{ review.email }}</small>
                </div>
            </div>

            <div class="review-info">
                <strong>Product:</strong> {{ review.product.name }}
            </div>

            <div class="review-rating">⭐ {{ review.rating }} / 5</div>

            <div class="review-text">
                {{ review.comment|linebreaks }}
            </div>

            {% if review.images.exists %}
            <div class="review-thumbs">
                {% for img in review.images.all %}
                <div class="thumb"
                     data-src="{{ img.image.url }}"
                     data-user="{{ review.first_name }} {{ review.last_name }}"
                     data-rating="{{ review.rating }}"
                     data-text="{{ review.comment|escapejs }}">
                    <img src="{{ img.image.url }}" alt="Review image">
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="review-actions">
                {% if review.is_approved %}
                    <span class="status-badge bg-success text-white">Approved</span>
                {% else %}
                    <span class="status-badge bg-warning text-dark">Pending</span>
                {% endif %}

                <form method="post" action="{% url 'approve_review' review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-success btn-review-action">Approve</button>
                </form>

                <form method="post" action="{% url 'delete_review' review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-review-action">Delete</button>
                </form>

                <form method="post" action="{% url 'ban_user_from_review' review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-dark btn-review-action">Ban User</button>
                </form>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h4 class="mb-3">No product reviews to moderate</h4>
            <p class="text-muted">New customer reviews will appear here once submitted.</p>
        </div>
    {% endif %}

    <!-- ── Blog Reviews ── -->
    <h4 class="section-title">Blog Post Reviews</h4>

    {% if blog_reviews %}
        {% for review in blog_reviews %}
        <div class="review-card">
            <div class="review-header">
                <div class="review-user">
                    <h5>{{ review.first_name }} {{ review.last_name }}</h5>
                    <small>{{ review.email }}</small>
                </div>
            </div>

            <div class="review-info">
                <strong>Post:</strong> {{ review.post.title }}
            </div>

            <div class="review-rating">⭐ {{ review.rating }} / 5</div>

            <div class="review-text">
                {{ review.comment|linebreaks }}
            </div>

            <div class="review-actions">
                {% if review.is_approved %}
                    <span class="status-badge bg-success text-white">Approved</span>
                {% else %}
                    <span class="status-badge bg-warning text-dark">Pending</span>
                {% endif %}

                <form method="post" action="{% url 'approve_blog_review' review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-success btn-review-action">Approve</button>
                </form>

                <form method="post" action="{% url 'delete_blog_review' review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-review-action">Delete</button>
                </form>

                <form method="post" action="{% url 'ban_user_from_blog_review' review.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-dark btn-review-action">Ban User</button>
                </form>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h4 class="mb-3">No blog reviews to moderate</h4>
            <p class="text-muted">Reviews on blog articles will appear here.</p>
        </div>
    {% endif %}

</div>

<!-- Image Preview Modal -->
<div class="img-modal" id="imgModal">
    <span class="modal-close-btn" id="closeModal">×</span>
    <div class="modal-body">
        <img class="modal-main-img" id="modalImg" src="" alt="Review photo">
        <h5 id="modalUser" class="mt-3 mb-2"></h5>
        <p id="modalRate" class="text-warning fw-bold fs-5 mb-2"></p>
        <p id="modalText" class="text-muted"></p>
    </div>
</div>

{% include 'freshbread/footer.html' %}

<script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
<script src="{% static 'js/popper.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<!-- your other scripts ... -->

<script>
document.addEventListener('DOMContentLoaded', () => {
    const thumbs = document.querySelectorAll('.thumb');
    const modal  = document.querySelector('.img-modal');
    const close  = document.getElementById('closeModal');
    const img    = document.getElementById('modalImg');
    const user   = document.getElementById('modalUser');
    const rate   = document.getElementById('modalRate');
    const text   = document.getElementById('modalText');

    thumbs.forEach(thumb => {
        thumb.addEventListener('click', () => {
            modal.classList.add('active');
            img.src = thumb.dataset.src;
            user.textContent = thumb.dataset.user;
            rate.textContent = `⭐ ${thumb.dataset.rating} / 5`;
            text.textContent = thumb.dataset.text;
        });
    });

    const closeModal = () => modal.classList.remove('active');

    close.addEventListener('click', closeModal);
    modal.addEventListener('click', e => {
        if (e.target === modal) closeModal();
    });
});
</script>

</body>
</html>