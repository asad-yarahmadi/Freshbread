{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Shopping Cart - Kingfood</title>

<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="{% static 'css/custom.css' %}">
<link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">

<style>
/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Order Summary */
#original-total {
  font-weight: bold;
  color: #555;
}

#savings-row {
  margin-top: 5px;
}

#savings-row strong {
  font-weight: bold;
  color: #dc3545; /* Ù‚Ø±Ù…Ø² Ø¨Ø±Ø§ÛŒ ØªØ§Ú©ÛŒØ¯ Ø±ÙˆÛŒ Ø³ÙˆØ¯ */
}

#total {
  font-weight: bold;
  color: #28a745; /* Ø³Ø¨Ø² Ø¨Ø±Ø§ÛŒ Ø¬Ù…Ø¹ Ù†Ù‡Ø§ÛŒÛŒ */
}

.p-4.border.rounded.shadow-sm.bg-light h4 {
  font-weight: 600;
  margin-bottom: 15px;
}

.p-4.border.rounded.shadow-sm.bg-light p {
  margin: 5px 0;
  font-size: 0.95rem;
}

.p-4.border.rounded.shadow-sm.bg-light h5 {
  margin-top: 10px;
  font-size: 1.2rem;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¬Ø¯ÙˆÙ„ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ */
.cart-box { 
  padding: 80px 0; 
  background-color: #fafafa; 
}
.cart-table th, .cart-table td { 
  text-align: center; 
  vertical-align: middle !important; 
}
.cart-table img { 
  width: 70px; 
  border-radius: 10px; 
}
.quantity-btn { 
  background: #28a745; 
  color: white; 
  border: none; 
  border-radius: 6px; 
  width: 32px; 
  height: 32px; 
  font-weight: bold; 
  cursor: pointer; 
}
.quantity-btn:hover { 
  background: #218838; 
}
.total-summary { 
  background: #fff; 
  border-radius: 15px; 
  padding: 25px; 
  box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
}
#empty-cart { 
  text-align: center; 
  padding: 50px 0; 
  font-size: 18px; 
  color: #666; 
}

/* Ø§ÙÚ©Øª Ø³Ù‡ Ù†Ù‚Ø·Ù‡ (Ù„ÙˆØ¯ÛŒÙ†Ú¯) */
.spinner-dots {
  display: inline-block;
  width: 24px;
  text-align: center;
}
.spinner-dots span {
  display: inline-block;
  width: 6px;
  height: 6px;
  margin: 0 1px;
  background-color: #a77a00;
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out both;
}
.spinner-dots span:nth-child(1) { animation-delay: 0s; }
.spinner-dots span:nth-child(2) { animation-delay: 0.2s; }
.spinner-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ùˆ ØªØ®ÙÛŒÙ */
.price-box {
  display: inline-block;
  text-align: center;
}
.old-price {
  text-decoration: line-through;
  color: #888;
  margin-right: 5px;
  font-size: 1.3rem;
}
.new-price {
  color: #28a745;
  font-weight: bold;
  font-size: 1.5rem;
}
.discount-badge {
  background: #dc3545;
  color: #ffffff;
  font-size: 0.8rem;
  padding: 2px 6px;
  border-radius: 4px;
  margin-bottom: 3px;
  display: inline-block;
}

/* ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø­ØµÙˆÙ„Ø§ØªÛŒ Ú©Ù‡ ØªØ®ÙÛŒÙ Ø¯Ø§Ø±Ù†Ø¯ */
.discount-row {
  border: 2px solid #ff4d4f; /* Ù†ÙˆØ§Ø± Ù‚Ø±Ù…Ø² */
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(255,77,79,0.6);
  transition: all 0.3s ease;
  position: relative;
}

/* Ø¯Ø±ØµØ¯ ØªØ®ÙÛŒÙ Ø¨Ø²Ø±Ú¯â€ŒØªØ± - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ */
.discount-row .discount-badge {
  position: absolute;
  top: -12px;
  right: 12px;                    /* Ø§Ø² -10px Ø¨Ù‡ 12px ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù… ØªØ§ Ø¯Ø§Ø®Ù„ Ø¨Ù…ÙˆÙ†Ù‡ */
  font-size: 1.1rem;              /* Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©ØªØ± ØªØ§ Ø¨ÛŒØ±ÙˆÙ† Ù†Ø²Ù†Ù‡ */
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 50%;
  background: linear-gradient(45deg, #ff1a1a, #ff6600);
  color: #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  transform: rotate(-10deg);
  z-index: 2;
  /* Ù…Ù‡Ù…: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§ÙØ²Ø§ÛŒØ´ Ø¹Ø±Ø¶ */
  clip-path: circle(50%);
}

/* Ù‡Ø§ÙˆØ± Ø±ÙˆÛŒ ØªØ®ÙÛŒÙ - Ø¨Ø§Ú©Ø³ Ø¸Ø§Ù‡Ø± Ø´ÙˆØ¯ */
.discount-row .discount-badge:hover::after {
  content: attr(data-discount) "% OFF";
  position: absolute;
  top: 40px;
  right: 0;
  background: #ff4d4f;
  color: #fff;
  padding: 4px 8px;
  border-radius: 6px;
  white-space: nowrap;
  font-size: 0.9rem;
  font-weight: bold;
  opacity: 1;
  transform: translateY(0);
  transition: all 0.3s ease;
}

/* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§Ú©Ø³ */
.discount-row .discount-badge::after {
  opacity: 0;
  pointer-events: none;
}

.finished-row{opacity:0.6;background:#eee}
.finished-row .increase-btn,.finished-row .decrease-btn{pointer-events:none;opacity:0.5}

/* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ */
@media (min-width: 769px) {
  .table-responsive {
    overflow-x: hidden !important;
  }
  .cart-table {
    width: 100% !important;
    table-layout: fixed;          /* Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…ÙˆÙ†Ù† */
  }
  .cart-table td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
}

/* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¸Ø§Ù‡Ø± Ø¯Ø³Ú©ØªØ§Ù¾ */
@media (max-width: 768px) {
  .cart-box { padding: 60px 0 40px; }

  .cart-table thead { display: none; }

  .cart-table tbody tr {
    display: block;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    padding: 15px;
  }

  .cart-table td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-align: right;
    border: none;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
  }

  .cart-table td:last-child { border-bottom: none; }

  .cart-table td::before {
    content: attr(data-label) ": ";
    font-weight: 600;
    color: #555;
    flex: 0 0 100px;
    text-align: left;
  }

  .cart-table img {
    width: 80px;
    height: 80px;
  }

  .quantity-btn {
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
  }

  .quantity-number {
    font-size: 1.2rem;
    min-width: 35px;
  }

  .p-4.border.rounded.shadow-sm.bg-light {
    padding: 20px !important;
  }

  /* Ø­Ø°Ù Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ø§ÙÙ‚ÛŒ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
  .table-responsive {
    overflow-x: hidden;
  }
}

/* Ù„ÛŒØ¨Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ØªÙˆÙ† Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
.cart-table td:nth-child(1):before { content: "Image"; }
.cart-table td:nth-child(2):before { content: "Product"; }
.cart-table td:nth-child(3):before { content: "Price"; }
.cart-table td:nth-child(4):before { content: "Quantity"; }
.cart-table td:nth-child(5):before { content: "Total"; }
/* ÙÙ‚Ø· Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡ */
@media (max-width: 768px) {
  .cart-table td::before {
    content: attr(data-label) ": ";
    font-weight: 600;
    color: #555;
    flex: 0 0 100px;
    text-align: left;
  }

  /* Ø¨Ù‚ÛŒÙ‡ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± */
  .cart-table thead { display: none; }
  .cart-table tbody tr { display: block; /* ... Ø¨Ù‚ÛŒÙ‡ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± */ }
}

/* Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ Ù‡ÛŒÚ† Ù„ÛŒØ¨Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ù† */
@media (min-width: 769px) {
  .cart-table td::before {
    content: none !important;  /* Ù…Ù‡Ù…: Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ø±Ùˆ Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ú©Ù† */
  }
}
</style>

{% include 'freshbread/header.html' %}

<div class="all-page-title page-breadcrumb">
  <div class="container text-center">
    <h1>ğŸ›’ Shopping Cart</h1>
  </div>
</div>

<div class="cart-box py-5">
  <div class="container">

    {% if not cart_items %}
      <div id="empty-cart" class="text-center p-5">
        <h3>Your cart is empty ğŸ›ï¸</h3>
        <p class="text-muted mt-3">Looks like you haven't added anything yet.</p>
        <a href="{% url 'menu' %}" class="btn btn-primary mt-3 px-4 py-2">Go to Menu</a>
      </div>
    {% else %}
    <div id="cart-section">
      <h2 class="mb-4 text-center">Your Shopping Cart</h2>

      <div class="table-responsive">
        <table class="table table-striped table-bordered text-center shadow-sm rounded cart-table">
          <thead class="thead-dark">
            <tr>
              <th>Image</th>
              <th>Product</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in cart_items %}
            <tr 
              data-slug="{{ item.product.slug }}" 
              data-price="{{ item.product.price }}"
              class="{% if item.product.original_price and item.product.original_price > item.product.price %}discount-row{% endif %} {% if not item.product.available %}finished-row{% endif %}">

              <td data-label="Image">
                <img src="{{ item.product.menu_image.url }}" alt="{{ item.product.name }}" width="80">
              </td>
              <td data-label="Product">{{ item.product.name }}</td>

              <td data-label="Price">
                <div class="price-box">
                  {% if item.product.original_price and item.product.original_price > item.product.price %}
                    <span class="discount-badge" data-discount="{{ item.product.discount_percent }}">{{ item.product.discount_percent }}%</span>
                    <span class="old-price">${{ item.product.original_price }}</span><br>
                    <span class="new-price">${{ item.product.price }}</span>
                  {% else %}
                    <span class="new-price">${{ item.product.price }}</span>
                  {% endif %}
                </div>
              </td>

              <td data-label="Quantity">
                {% if not item.product.available %}
                  <div class="text-danger fw-bold small">Out of stock</div>
                {% else %}
                  <div class="d-flex justify-content-center align-items-center">
                    <button class="btn btn-sm btn-outline-secondary decrease-btn" {% if not item.product.available %}disabled{% endif %}>âˆ’</button>
                    <span class="mx-2 quantity-number" data-qty="{{ item.quantity }}">{{ item.quantity }}</span>
                    <button class="btn btn-sm btn-success increase-btn" {% if not item.product.available %}disabled{% endif %}>+</button>
                  </div>
                {% endif %}
              </td>

              <td data-label="Total" class="item-total">${{ item.total_price|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="row mt-5">
        <div class="col-lg-4 ml-auto">
          <div class="p-4 border rounded shadow-sm bg-light">
            <h4 class="mb-3">Order Summary</h4>
            {% if referral_code %}
            <div class="alert alert-warning" role="alert" style="border-radius:12px;">
              <div class="d-flex align-items-start">
                <i class="fa fa-lightbulb-o me-2" aria-hidden="true" style="margin-right:8px"></i>
                <div>
                  <strong>Pro tip:</strong> Share your code <code>{{ referral_code }}</code>.
                  For every 7 people who order using your code, youâ€™ll receive a $50 discount code.
                  {% if referral_orders_count is not None %}
                    <div class="mt-1">Completed referral orders: <strong>{{ referral_orders_count }}</strong></div>
                    {% if next_reward_in and next_reward_in > 0 %}
                      <div>Next reward in <strong>{{ next_reward_in }}</strong> more orders.</div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            <p>Original Total: <strong id="original-total">${{ original_total|floatformat:2 }}</strong></p>
            <p id="savings-row" {% if savings <= 0 %}style="display:none;"{% endif %}>
              You Save: <strong id="savings">${{ savings|floatformat:2 }}</strong>
            </p>
            <hr>
            <h5>Total: <strong class="text-success" id="total">${{ total|floatformat:2 }}</strong></h5>
            <hr>
            {% if total <= 0 %}
              <a href="#" class="btn btn-secondary btn-block disabled" aria-disabled="true">Proceed to Checkout</a>
            {% else %}
              <a href="{% url 'checkout_s1' %}" class="btn btn-success btn-block">Proceed to Checkout</a>
            {% endif %}
          </div>
        </div>
      </div>

      <a href="{% url 'menu' %}" class="btn btn-outline-primary mt-4">â† Continue Shopping</a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Start Customer Reviews -->
<div class="customer-reviews-box">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="heading-title text-center">
          <h2>Customer Reviews</h2>
          <p>You can know Reviews from our Customers (you can add too!)</p>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8 mr-auto ml-auto text-center">
        <div id="reviews" class="carousel slide" data-ride="carousel">
          <div class="carousel-inner mt-4">
            <div class="carousel-item text-center active">
              <div class="img-box p-1 border rounded-circle m-auto">
                <img class="d-block w-100 rounded-circle" src="{% static 'images/profile-1.jpg' %}" alt="">
              </div>
              <h5 class="mt-4 mb-0"><strong class="text-warning text-uppercase">Paul Mitchel</strong></h5>
              <h6 class="text-dark m-0">Web Developer</h6>
              <p class="m-0 pt-3">It has a lot of delicious food. It also has a very strong website designer. Overall, thank you.</p>
            </div>
            <div class="carousel-item text-center">
              <div class="img-box p-1 border rounded-circle m-auto">
                <img class="d-block w-100 rounded-circle" src="{% static 'images/profile-3.jpg' %}" alt="">
              </div>
              <h5 class="mt-4 mb-0"><strong class="text-warning text-uppercase">Steve Fonsi</strong></h5>
              <h6 class="text-dark m-0">Web Designer</h6>
              <p class="m-0 pt-3">It has good food and user interface. Thanks.</p>
            </div>
            <div class="carousel-item text-center">
              <div class="img-box p-1 border rounded-circle m-auto">
                <img class="d-block w-100 rounded-circle" src="{% static 'images/profile-7.jpg' %}" alt="">
              </div>
              <h5 class="mt-4 mb-0"><strong class="text-warning text-uppercase">Daniel vebar</strong></h5>
              <h6 class="text-dark m-0">Seo Analyst</h6>
              <p class="m-0 pt-3">Good and tasty food and fast foods. I think in Otawwa and Knanta its the best Fast food and bakery here.</p>
            </div>
          </div>
          <a class="carousel-control-prev" href="#reviews" role="button" data-slide="prev">
            <i class="fa fa-angle-left" aria-hidden="true"></i>
            <span class="sr-only">Previous</span>
          </a>
          <a class="carousel-control-next" href="#reviews" role="button" data-slide="next">
            <i class="fa fa-angle-right" aria-hidden="true"></i>
            <span class="sr-only">Next</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Customer Reviews -->

{% include 'freshbread/footer.html' %}

<script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrfToken = '{{ csrf_token }}';

  function updateSummaryTotals(data) {
    if (data.original_total !== undefined) {
      document.getElementById('original-total').textContent = '$' + Number(data.original_total).toFixed(2);
    }
    if (data.savings !== undefined) {
      const savingsVal = Number(data.savings);
      const savingsRow = document.getElementById('savings-row');
      document.getElementById('savings').textContent = '$' + savingsVal.toFixed(2);
      savingsRow.style.display = savingsVal > 0 ? '' : 'none';
    }
    if (data.total !== undefined) {
      document.getElementById('total').textContent = '$' + Number(data.total).toFixed(2);
    }
  }

  function updateDecreaseBtn(row, quantity) {
    const decreaseBtn = row.querySelector('.decrease-btn');
    if (quantity === 1) {
      decreaseBtn.classList.remove('btn-outline-secondary');
      decreaseBtn.classList.add('btn-danger');
      decreaseBtn.textContent = 'ğŸ—‘ï¸';
    } else {
      decreaseBtn.classList.remove('btn-danger');
      decreaseBtn.classList.add('btn-outline-secondary');
      decreaseBtn.textContent = 'âˆ’';
    }
  }

  function removeRow(row) {
    row.style.transition = 'opacity 0.3s';
    row.style.opacity = 0;
    setTimeout(() => {
      row.remove();
      const tbody = document.querySelector('#cart-section tbody');
      if (!tbody || tbody.children.length === 0) {
        document.getElementById('cart-section').innerHTML = `
          <div id="empty-cart" class="text-center p-5">
            <h3>Your cart is empty ğŸ›ï¸</h3>
            <p class="text-muted mt-3">Looks like you haven't added anything yet.</p>
            <a href="{% url 'menu' %}" class="btn btn-primary mt-3 px-4 py-2">Go to Menu</a>
          </div>`;
      }
    }, 300);
  }

  function updateQuantity(slug, quantitySpan, newQty) {
    const row = quantitySpan.closest('tr');
    const increaseBtn = row.querySelector('.increase-btn');

    quantitySpan.innerHTML = `<span class="spinner-dots"><span></span><span></span><span></span></span>`;

    fetch(`/cart/set_cart_quantity/${slug}/${newQty}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        quantitySpan.dataset.qty = data.quantity;

        if (data.quantity === 0) {
          removeRow(row);
          updateSummaryTotals(data);
          return;
        }

        quantitySpan.textContent = data.quantity;

        const unitPrice = Number(row.dataset.price) || 0;
        row.querySelector('.item-total').textContent = '$' + (unitPrice * data.quantity).toFixed(2);

        updateSummaryTotals(data);
        updateDecreaseBtn(row, data.quantity);
        increaseBtn.disabled = data.quantity >= 5;
      } else {
        alert(data.message || 'Error updating cart');
      }
    })
    .catch(console.error);
  }

  document.querySelectorAll('.increase-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const row = btn.closest('tr');
      const slug = row.dataset.slug;
      const quantitySpan = row.querySelector('.quantity-number');
      const qty = parseInt(quantitySpan.dataset.qty || quantitySpan.textContent) || 0;
      if (qty < 5) updateQuantity(slug, quantitySpan, qty + 1);
    });
  });

  document.querySelectorAll('.decrease-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const row = btn.closest('tr');
      const slug = row.dataset.slug;
      const quantitySpan = row.querySelector('.quantity-number');
      const qty = parseInt(quantitySpan.dataset.qty) || 0;

      if (qty > 1) {
        updateQuantity(slug, quantitySpan, qty - 1);
      } else if (qty === 1) {
        updateQuantity(slug, quantitySpan, 0);
      }
    });
  });

  document.querySelectorAll('#cart-section tbody tr').forEach(row => {
    const qty = parseInt(row.querySelector('.quantity-number').dataset.qty) || 0;
    updateDecreaseBtn(row, qty);
  });
});
</script>

</body>
</html>